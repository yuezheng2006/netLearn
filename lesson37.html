<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>37讲 | 知识串讲：用双十一的故事串起碎片的网络协议（上） | 网络协议学习</title>
    <meta name="description" content="想成为技术牛人？先搞定网络协议">
    <link rel="icon" href="/netLearn/http.png">
  <link rel="manifest" href="/netLearn/manifest.json">
    
    <link rel="preload" href="/netLearn/assets/css/0.styles.b1407e59.css" as="style"><link rel="preload" href="/netLearn/assets/js/app.2914d2f8.js" as="script"><link rel="preload" href="/netLearn/assets/js/10.26371369.js" as="script"><link rel="prefetch" href="/netLearn/assets/js/22.0ecb65f5.js"><link rel="prefetch" href="/netLearn/assets/js/1.2dde6845.js"><link rel="prefetch" href="/netLearn/assets/js/2.a4e6a5c5.js"><link rel="prefetch" href="/netLearn/assets/js/3.5c505085.js"><link rel="prefetch" href="/netLearn/assets/js/4.d1c55cea.js"><link rel="prefetch" href="/netLearn/assets/js/5.692adc04.js"><link rel="prefetch" href="/netLearn/assets/js/6.6eb18b6a.js"><link rel="prefetch" href="/netLearn/assets/js/7.a62cab1b.js"><link rel="prefetch" href="/netLearn/assets/js/8.a25bbd73.js"><link rel="prefetch" href="/netLearn/assets/js/9.779528af.js"><link rel="prefetch" href="/netLearn/assets/js/11.e1058a42.js"><link rel="prefetch" href="/netLearn/assets/js/12.5b23976f.js"><link rel="prefetch" href="/netLearn/assets/js/13.40dd83ea.js"><link rel="prefetch" href="/netLearn/assets/js/14.07741444.js"><link rel="prefetch" href="/netLearn/assets/js/15.f60494a5.js"><link rel="prefetch" href="/netLearn/assets/js/16.f108ef2b.js"><link rel="prefetch" href="/netLearn/assets/js/17.a42a2cbd.js"><link rel="prefetch" href="/netLearn/assets/js/18.80fa4fa1.js"><link rel="prefetch" href="/netLearn/assets/js/19.cc5759a4.js"><link rel="prefetch" href="/netLearn/assets/js/20.586fd498.js"><link rel="prefetch" href="/netLearn/assets/js/21.d42138c5.js"><link rel="prefetch" href="/netLearn/assets/js/23.df13818e.js"><link rel="prefetch" href="/netLearn/assets/js/24.0e52a71a.js"><link rel="prefetch" href="/netLearn/assets/js/25.f4a9d0cc.js"><link rel="prefetch" href="/netLearn/assets/js/26.404f384a.js"><link rel="prefetch" href="/netLearn/assets/js/27.a863d69a.js"><link rel="prefetch" href="/netLearn/assets/js/28.d7cc877b.js"><link rel="prefetch" href="/netLearn/assets/js/29.b47ecaa2.js"><link rel="prefetch" href="/netLearn/assets/js/30.f727453f.js"><link rel="prefetch" href="/netLearn/assets/js/31.e9226cac.js"><link rel="prefetch" href="/netLearn/assets/js/32.c4045b97.js"><link rel="prefetch" href="/netLearn/assets/js/33.54de50f3.js"><link rel="prefetch" href="/netLearn/assets/js/34.c22e8566.js"><link rel="prefetch" href="/netLearn/assets/js/35.0fa76008.js"><link rel="prefetch" href="/netLearn/assets/js/36.93d1ec74.js"><link rel="prefetch" href="/netLearn/assets/js/37.86f84e99.js"><link rel="prefetch" href="/netLearn/assets/js/38.4e6aaa80.js"><link rel="prefetch" href="/netLearn/assets/js/39.83d0b4af.js"><link rel="prefetch" href="/netLearn/assets/js/40.85e9fe2d.js"><link rel="prefetch" href="/netLearn/assets/js/41.c18e2cc3.js"><link rel="prefetch" href="/netLearn/assets/js/42.a37c9de2.js"><link rel="prefetch" href="/netLearn/assets/js/43.f8744481.js"><link rel="prefetch" href="/netLearn/assets/js/44.f0b6384a.js"><link rel="prefetch" href="/netLearn/assets/js/45.fbf3d342.js">
    <link rel="stylesheet" href="/netLearn/assets/css/0.styles.b1407e59.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/netLearn/" class="home-link router-link-active"><!----> <span class="site-name">网络协议学习</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netLearn/" class="nav-link">首页</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netLearn/" class="nav-link">首页</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>网络协议课程</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/netLearn/intro.html" class="sidebar-link">前言</a></li><li><a href="/netLearn/lesson1.html" class="sidebar-link">为什么要学习网络协议</a></li><li><a href="/netLearn/lesson2.html" class="sidebar-link">网络分层的真实含义</a></li><li><a href="/netLearn/lesson3.html" class="sidebar-link">ifconfig命令</a></li><li><a href="/netLearn/lesson4.html" class="sidebar-link">DHCP和PXE</a></li><li><a href="/netLearn/lesson5.html" class="sidebar-link">从物理层到MAC层</a></li><li><a href="/netLearn/lesson6.html" class="sidebar-link">交换机与VLAN</a></li><li><a href="/netLearn/lesson7.html" class="sidebar-link">ICMP与ping</a></li><li><a href="/netLearn/lesson8.html" class="sidebar-link">世界那么大，我想出网关</a></li><li><a href="/netLearn/lesson9.html" class="sidebar-link">路由协议</a></li><li><a href="/netLearn/lesson10.html" class="sidebar-link">UDP协议</a></li><li><a href="/netLearn/lesson11.html" class="sidebar-link">TCP协议上</a></li><li><a href="/netLearn/lesson12.html" class="sidebar-link">TCP协议下</a></li><li><a href="/netLearn/lesson13.html" class="sidebar-link">套接字</a></li><li><a href="/netLearn/lesson14.html" class="sidebar-link">http协议</a></li><li><a href="/netLearn/lesson15.html" class="sidebar-link">https协议</a></li><li><a href="/netLearn/lesson16.html" class="sidebar-link">流媒体协议</a></li><li><a href="/netLearn/lesson17.html" class="sidebar-link">P2P协议</a></li><li><a href="/netLearn/lesson18.html" class="sidebar-link">DNS协议</a></li><li><a href="/netLearn/lesson19.html" class="sidebar-link">HTTPDNS</a></li><li><a href="/netLearn/lesson20.html" class="sidebar-link">CDN</a></li><li><a href="/netLearn/lesson21.html" class="sidebar-link">数据中心</a></li><li><a href="/netLearn/lesson22.html" class="sidebar-link">VPN</a></li><li><a href="/netLearn/lesson23.html" class="sidebar-link">移动网络</a></li><li><a href="/netLearn/lesson24.html" class="sidebar-link">云中网络</a></li><li><a href="/netLearn/lesson25.html" class="sidebar-link">软件定义网络</a></li><li><a href="/netLearn/lesson26.html" class="sidebar-link">云中的网络安全</a></li><li><a href="/netLearn/lesson27.html" class="sidebar-link">云中的网络 QoS</a></li><li><a href="/netLearn/lesson28.html" class="sidebar-link">云中网络的隔离</a></li><li><a href="/netLearn/lesson29.html" class="sidebar-link">容器网络</a></li><li><a href="/netLearn/lesson30.html" class="sidebar-link">容器网络之Flannel</a></li><li><a href="/netLearn/lesson31.html" class="sidebar-link">容器网络之Calico</a></li><li><a href="/netLearn/lesson32.html" class="sidebar-link">RPC协议综述</a></li><li><a href="/netLearn/lesson33.html" class="sidebar-link">基于XML的SOAP协议</a></li><li><a href="/netLearn/lesson34.html" class="sidebar-link">基于JSON的RESTful接口协议</a></li><li><a href="/netLearn/lesson35.html" class="sidebar-link">二进制类RPC协议</a></li><li><a href="/netLearn/lesson36.html" class="sidebar-link">跨语言类 RPC 协议</a></li><li><a href="/netLearn/lesson37.html" class="active sidebar-link">知识串讲：用双十一的故事串起碎片的网络协议（上）</a></li><li><a href="/netLearn/lesson38.html" class="sidebar-link">知识串讲：用双十一的故事串起碎片的网络协议（中）</a></li><li><a href="/netLearn/lesson39.html" class="sidebar-link">知识串讲：用双十一的故事串起碎片的网络协议（下）</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="_37讲-知识串讲：用双十一的故事串起碎片的网络协议（上）"><a href="#_37讲-知识串讲：用双十一的故事串起碎片的网络协议（上）" aria-hidden="true" class="header-anchor">#</a> 37讲 | 知识串讲：用双十一的故事串起碎片的网络协议（上）</h1> <blockquote><p>2018-08-10 刘超</p></blockquote> <!----> <p>基本的网络知识我们都讲完了，还记得最初举的那个“双十一”下单的例子吗？这一节开始，我们详细地讲解这个过程，用这个过程串起我们讲过的网络协议。</p> <p>我把这个过程分为十个阶段，从云平台中搭建一个电商开始，到 BGP 路由广播，再到 DNS 域名解析，从客户看商品图片，到最终下单的整个过程，每一步我都会详细讲解。这节我们先来看前三个阶段。</p> <h2 id="_1-部署一个高可用高并发的电商平台"><a href="#_1-部署一个高可用高并发的电商平台" aria-hidden="true" class="header-anchor">#</a> 1. 部署一个高可用高并发的电商平台</h2> <p>首先，咱们要有个电商平台。假设我们已经有了一个特别大的电商平台，这个平台应该部署在哪里呢？假设我们用公有云，一般公有云会有多个位置，比如在华东、华北、华南都有。毕竟咱们的电商是要服务全国的，当然到处都要部署了。我们把主站点放在华东。</p> <!----> <p>为了每个点都能“雨露均沾”，也为了高可用性，往往需要有多个机房，形成多个可用区（Available Zone）。由于咱们的应用是分布在两个可用区的，所以假如任何一个可用区挂了，都不会受影响。</p> <p>我们来回想数据中心那一节，每个可用区里有一片一片的机柜，每个机柜上有一排一排的服务器，每个机柜都有一个接入交换机，有一个汇聚交换机将多个机柜连在一起。</p> <p>这些服务器里面部署的都是计算节点，每台上面都有 Open vSwitch 创建的虚拟交换机，将来在这台机器上创建的虚拟机，都会连到 Open vSwitch 上。</p> <!----> <p>接下来，你<strong>在云计算的界面上创建一个 VPC（Virtual Private Cloud，虚拟私有网络）</strong>，指定一个 IP 段，这样以后你部署的所有应用都会在这个虚拟网络里，使用你分配的这个 IP 段。为了不同的 VPC 相互隔离，每个 VPC 都会被分配一个 VXLAN 的 ID。尽管不同用户的虚拟机有可能在同一个物理机上，但是不同的 VPC 二层压根儿是不通的。</p> <p>由于有两个可用区，在这个 VPC 里面，要为每一个可用区分配一个 Subnet，也就是在大的网段里分配两个小的网段。当两个可用区里面网段不同的时候，就可以配置路由策略，访问另外一个可用区，走某一条路由了。</p> <p>接下来，应该创建数据库持久化层。大部分云平台都会提供 PaaS 服务，也就是说，不需要你自己搭建数据库，而是采用直接提供数据库的服务，并且单机房的主备切换都是默认做好的，数据库也是部署在虚拟机里面的，只不过从界面上，你看不到数据库所在的虚拟机而已。</p> <p>云平台会给每个 Subnet 的数据库实例分配一个域名。创建数据库实例的时候，需要你指定可用区和 Subnet，这样创建出来的数据库实例可以通过这个 Subnet 的私网 IP 进行访问。</p> <p>为了分库分表实现高并发的读写，在创建的多个数据库实例之上，会创建一个分布式数据库的实例，也需要指定可用区和 Subnet，还会为分布式数据库分配一个私网 IP 和域名。</p> <p>对于数据库这种高可用性比较高的，需要进行跨机房高可用，因而两个可用区都要部署一套，但是只有一个是主，另外一个是备，云平台往往会提供数据库同步工具，将应用写入主的数据同步给备数据库集群。</p> <p>接下来是创建缓存集群。云平台也会提供 PaaS 服务，也需要每个可用区和 Subnet 创建一套，缓存的数据在内存中，由于读写性能要求高，一般不要求跨可用区读写。</p> <p>再往上层就是部署咱们自己写的程序了。基础服务层、组合服务层、Controller 层，以及 Nginx 层、API 网关等等，这些都是部署在虚拟机里面的。它们之间通过 RPC 相互调用，需要到注册中心进行注册。</p> <p>它们之间的网络通信是虚拟机和虚拟机之间的。如果是同一台物理机，则那台物理机上的 OVS 就能转发过去；如果是不同的物理机，这台物理机的 OVS 和另一台物理机的 OVS 中间有一个 VXLAN 的隧道，将请求转发过去。</p> <p>再往外就是负载均衡了，负载均衡也是云平台提供的 PaaS 服务，也是属于某个 VPC 的，部署在虚拟机里面的，但是负载均衡有个外网的 IP，这个外网的 IP 地址就是在网关节点的外网网口上的。在网关节点上，会有 NAT 规则，将外网 IP 地址转换为 VPC 里面的私网 IP 地址，通过这些私网 IP 地址访问到虚拟机上的负载均衡节点，然后通过负载均衡节点转发到 API 网关的节点。</p> <p>网关节点的外网网口是带公网 IP 地址的，里面有一个虚拟网关转发模块，还会有一个 OVS，将私网 IP 地址放到 VXLAN 隧道里面，转发到虚拟机上，从而实现外网和虚拟机网络之间的互通。</p> <p>不同的可用区之间，通过核心交换机连在一起，核心交换机之外是边界路由器。</p> <p>在华北、华东、华南同样也部署了一整套，每个地区都创建了 VPC，这就需要有一种机制将 VPC 连接到一起。云平台一般会提供硬件的 VPC 互连的方式，当然也可以使用软件互连的方式，也就是使用 VPN 网关，通过 IPsec VPN 将不同地区的不同 VPC 通过 VPN 连接起来。</p> <p>对于不同地区和不同运营商的用户，我们希望他能够就近访问到网站，而且当一个点出了故障之后，我们希望能够在不同的地区之间切换，这就需要有智能 DNS，这个也是云平台提供的。</p> <p>对于一些静态资源，可以保持在对象存储里面，通过 CDN 下发到边缘节点，这样客户端就能尽快加载出来。</p> <h2 id="_2-大声告诉全世界，可以到我这里买东西"><a href="#_2-大声告诉全世界，可以到我这里买东西" aria-hidden="true" class="header-anchor">#</a> 2. 大声告诉全世界，可以到我这里买东西</h2> <p>当电商应用搭建完毕之后，接下来需要将如何访问到这个电商网站广播给全网。</p> <p>刚才那张图画的是一个可用区的情况，对于多个可用区的情况，我们可以隐去计算节点的情况，将外网访问区域放大。</p> <!----> <p>外网 IP 是放在虚拟网关的外网网口上的，这个 IP 如何让全世界知道呢？当然是通过 BGP 路由协议了。</p> <p>每个可用区都有自己的汇聚交换机，如果机器数目比较多，可以直接用核心交换机，每个 Region 也有自己的核心交换区域。</p> <p>在核心交换外面是安全设备，然后就是边界路由器。边界路由器会和多个运营商连接，从而每个运营商都能够访问到这个网站。边界路由器可以通过 BGP 协议，将自己数据中心里面的外网 IP 向外广播，也就是告诉全世界，如果要访问这些外网 IP，都来我这里。</p> <p>每个运营商也有很多的路由器、很多的点，于是就可以将如何到达这些 IP 地址的路由信息，广播到全国乃至全世界。</p> <h2 id="_3-打开手机来上网，域名解析得地址"><a href="#_3-打开手机来上网，域名解析得地址" aria-hidden="true" class="header-anchor">#</a> 3. 打开手机来上网，域名解析得地址</h2> <p>这个时候，不但你的这个网站的 IP 地址全世界都知道了，你打的广告可能大家也都看到了，于是有客户下载 App 来买东西了。</p> <!----> <p>客户的手机开机以后，在附近寻找基站 eNodeB，发送请求，申请上网。基站将请求发给 MME，MME 对手机进行认证和鉴权，还会请求 HSS 看有没有钱，看看是在哪里上网。</p> <p>当 MME 通过了手机的认证之后，开始建立隧道，建设的数据通路分两段路，其实是两个隧道。一段是从 eNodeB 到 SGW，第二段是从 SGW 到 PGW，在 PGW 之外，就是互联网。</p> <p>PGW 会为手机分配一个 IP 地址，手机上网都是带着这个 IP 地址的。</p> <p>当在手机上面打开一个 App 的时候，首先要做的事情就是解析这个网站的域名。</p> <p>在手机运营商所在的互联网区域里，有一个本地的 DNS，手机会向这个 DNS 请求解析 DNS。当这个 DNS 本地有缓存，则直接返回；如果没有缓存，本地 DNS 才需要递归地从根 DNS 服务器，查到.com 的顶级域名服务器，最终查到权威 DNS 服务器。</p> <p>如果你使用云平台的时候，配置了智能 DNS 和全局负载均衡，在权威 DNS 服务中，一般是通过配置 CNAME 的方式，我们可以起一个别名，例如 vip.yourcomany.com ，然后告诉本地 DNS 服务器，让它请求 GSLB 解析这个域名，GSLB 就可以在解析这个域名的过程中，通过自己的策略实现负载均衡。</p> <p>GSLB 通过查看请求它的本地 DNS 服务器所在的运营商和地址，就知道用户所在的运营商和地址，然后将距离用户位置比较近的 Region 里面，三个负载均衡 SLB 的公网 IP 地址，返回给本地 DNS 服务器。本地 DNS 解析器将结果缓存后，返回给客户端。</p> <p>对于手机 App 来说，可以绕过刚才的传统 DNS 解析机制，直接只要 HTTPDNS 服务，通过直接调用 HTTPDNS 服务器，得到这三个 SLB 的公网 IP 地址。</p> <p>看，经过了如此复杂的过程，咱们的万里长征还没迈出第一步，刚刚得到 IP 地址，包还没发呢？话说手机 App 拿到了公网 IP 地址，接下来应该做什么呢？</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/netLearn/lesson36.html" class="prev">
          跨语言类 RPC 协议
        </a></span> <span class="next"><a href="/netLearn/lesson38.html">
          知识串讲：用双十一的故事串起碎片的网络协议（中）
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/netLearn/assets/js/10.26371369.js" defer></script><script src="/netLearn/assets/js/app.2914d2f8.js" defer></script>
  </body>
</html>
