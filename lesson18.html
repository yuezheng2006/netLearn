<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第18讲 | DNS协议：网络世界的地址簿 | 网络协议学习</title>
    <meta name="description" content="想成为技术牛人？先搞定网络协议">
    <link rel="icon" href="/netLearn/http.png">
  <link rel="manifest" href="/netLearn/manifest.json">
    
    <link rel="preload" href="/netLearn/assets/css/0.styles.b1407e59.css" as="style"><link rel="preload" href="/netLearn/assets/js/app.2914d2f8.js" as="script"><link rel="preload" href="/netLearn/assets/js/31.e9226cac.js" as="script"><link rel="prefetch" href="/netLearn/assets/js/22.0ecb65f5.js"><link rel="prefetch" href="/netLearn/assets/js/1.2dde6845.js"><link rel="prefetch" href="/netLearn/assets/js/2.a4e6a5c5.js"><link rel="prefetch" href="/netLearn/assets/js/3.5c505085.js"><link rel="prefetch" href="/netLearn/assets/js/4.d1c55cea.js"><link rel="prefetch" href="/netLearn/assets/js/5.692adc04.js"><link rel="prefetch" href="/netLearn/assets/js/6.6eb18b6a.js"><link rel="prefetch" href="/netLearn/assets/js/7.a62cab1b.js"><link rel="prefetch" href="/netLearn/assets/js/8.a25bbd73.js"><link rel="prefetch" href="/netLearn/assets/js/9.779528af.js"><link rel="prefetch" href="/netLearn/assets/js/10.26371369.js"><link rel="prefetch" href="/netLearn/assets/js/11.e1058a42.js"><link rel="prefetch" href="/netLearn/assets/js/12.5b23976f.js"><link rel="prefetch" href="/netLearn/assets/js/13.40dd83ea.js"><link rel="prefetch" href="/netLearn/assets/js/14.07741444.js"><link rel="prefetch" href="/netLearn/assets/js/15.f60494a5.js"><link rel="prefetch" href="/netLearn/assets/js/16.f108ef2b.js"><link rel="prefetch" href="/netLearn/assets/js/17.a42a2cbd.js"><link rel="prefetch" href="/netLearn/assets/js/18.80fa4fa1.js"><link rel="prefetch" href="/netLearn/assets/js/19.cc5759a4.js"><link rel="prefetch" href="/netLearn/assets/js/20.586fd498.js"><link rel="prefetch" href="/netLearn/assets/js/21.d42138c5.js"><link rel="prefetch" href="/netLearn/assets/js/23.df13818e.js"><link rel="prefetch" href="/netLearn/assets/js/24.0e52a71a.js"><link rel="prefetch" href="/netLearn/assets/js/25.f4a9d0cc.js"><link rel="prefetch" href="/netLearn/assets/js/26.404f384a.js"><link rel="prefetch" href="/netLearn/assets/js/27.a863d69a.js"><link rel="prefetch" href="/netLearn/assets/js/28.d7cc877b.js"><link rel="prefetch" href="/netLearn/assets/js/29.b47ecaa2.js"><link rel="prefetch" href="/netLearn/assets/js/30.f727453f.js"><link rel="prefetch" href="/netLearn/assets/js/32.c4045b97.js"><link rel="prefetch" href="/netLearn/assets/js/33.54de50f3.js"><link rel="prefetch" href="/netLearn/assets/js/34.c22e8566.js"><link rel="prefetch" href="/netLearn/assets/js/35.0fa76008.js"><link rel="prefetch" href="/netLearn/assets/js/36.93d1ec74.js"><link rel="prefetch" href="/netLearn/assets/js/37.86f84e99.js"><link rel="prefetch" href="/netLearn/assets/js/38.4e6aaa80.js"><link rel="prefetch" href="/netLearn/assets/js/39.83d0b4af.js"><link rel="prefetch" href="/netLearn/assets/js/40.85e9fe2d.js"><link rel="prefetch" href="/netLearn/assets/js/41.c18e2cc3.js"><link rel="prefetch" href="/netLearn/assets/js/42.a37c9de2.js"><link rel="prefetch" href="/netLearn/assets/js/43.f8744481.js"><link rel="prefetch" href="/netLearn/assets/js/44.f0b6384a.js"><link rel="prefetch" href="/netLearn/assets/js/45.fbf3d342.js">
    <link rel="stylesheet" href="/netLearn/assets/css/0.styles.b1407e59.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/netLearn/" class="home-link router-link-active"><!----> <span class="site-name">网络协议学习</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netLearn/" class="nav-link">首页</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netLearn/" class="nav-link">首页</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>网络协议课程</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/netLearn/intro.html" class="sidebar-link">前言</a></li><li><a href="/netLearn/lesson1.html" class="sidebar-link">为什么要学习网络协议</a></li><li><a href="/netLearn/lesson2.html" class="sidebar-link">网络分层的真实含义</a></li><li><a href="/netLearn/lesson3.html" class="sidebar-link">ifconfig命令</a></li><li><a href="/netLearn/lesson4.html" class="sidebar-link">DHCP和PXE</a></li><li><a href="/netLearn/lesson5.html" class="sidebar-link">从物理层到MAC层</a></li><li><a href="/netLearn/lesson6.html" class="sidebar-link">交换机与VLAN</a></li><li><a href="/netLearn/lesson7.html" class="sidebar-link">ICMP与ping</a></li><li><a href="/netLearn/lesson8.html" class="sidebar-link">世界那么大，我想出网关</a></li><li><a href="/netLearn/lesson9.html" class="sidebar-link">路由协议</a></li><li><a href="/netLearn/lesson10.html" class="sidebar-link">UDP协议</a></li><li><a href="/netLearn/lesson11.html" class="sidebar-link">TCP协议上</a></li><li><a href="/netLearn/lesson12.html" class="sidebar-link">TCP协议下</a></li><li><a href="/netLearn/lesson13.html" class="sidebar-link">套接字</a></li><li><a href="/netLearn/lesson14.html" class="sidebar-link">http协议</a></li><li><a href="/netLearn/lesson15.html" class="sidebar-link">https协议</a></li><li><a href="/netLearn/lesson16.html" class="sidebar-link">流媒体协议</a></li><li><a href="/netLearn/lesson17.html" class="sidebar-link">P2P协议</a></li><li><a href="/netLearn/lesson18.html" class="active sidebar-link">DNS协议</a></li><li><a href="/netLearn/lesson19.html" class="sidebar-link">HTTPDNS</a></li><li><a href="/netLearn/lesson20.html" class="sidebar-link">CDN</a></li><li><a href="/netLearn/lesson21.html" class="sidebar-link">数据中心</a></li><li><a href="/netLearn/lesson22.html" class="sidebar-link">VPN</a></li><li><a href="/netLearn/lesson23.html" class="sidebar-link">移动网络</a></li><li><a href="/netLearn/lesson24.html" class="sidebar-link">云中网络</a></li><li><a href="/netLearn/lesson25.html" class="sidebar-link">软件定义网络</a></li><li><a href="/netLearn/lesson26.html" class="sidebar-link">云中的网络安全</a></li><li><a href="/netLearn/lesson27.html" class="sidebar-link">云中的网络 QoS</a></li><li><a href="/netLearn/lesson28.html" class="sidebar-link">云中网络的隔离</a></li><li><a href="/netLearn/lesson29.html" class="sidebar-link">容器网络</a></li><li><a href="/netLearn/lesson30.html" class="sidebar-link">容器网络之Flannel</a></li><li><a href="/netLearn/lesson31.html" class="sidebar-link">容器网络之Calico</a></li><li><a href="/netLearn/lesson32.html" class="sidebar-link">RPC协议综述</a></li><li><a href="/netLearn/lesson33.html" class="sidebar-link">基于XML的SOAP协议</a></li><li><a href="/netLearn/lesson34.html" class="sidebar-link">基于JSON的RESTful接口协议</a></li><li><a href="/netLearn/lesson35.html" class="sidebar-link">二进制类RPC协议</a></li><li><a href="/netLearn/lesson36.html" class="sidebar-link">跨语言类 RPC 协议</a></li><li><a href="/netLearn/lesson37.html" class="sidebar-link">知识串讲：用双十一的故事串起碎片的网络协议（上）</a></li><li><a href="/netLearn/lesson38.html" class="sidebar-link">知识串讲：用双十一的故事串起碎片的网络协议（中）</a></li><li><a href="/netLearn/lesson39.html" class="sidebar-link">知识串讲：用双十一的故事串起碎片的网络协议（下）</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="第18讲-dns协议：网络世界的地址簿"><a href="#第18讲-dns协议：网络世界的地址簿" aria-hidden="true" class="header-anchor">#</a> 第18讲 | DNS协议：网络世界的地址簿</h1> <blockquote><p>2018-06-27 刘超</p></blockquote> <!----> <p>前面我们讲了平时常见的看新闻、支付、直播、下载等场景，现在网站的数目非常多，常用的网站就有二三十个，如果全部用 IP 地址进行访问，恐怕很难记住。于是，就需要一个地址簿，根据名称，就可以查看具体的地址。</p> <p>例如，我要去西湖边的“外婆家”，这就是名称，然后通过地址簿，查看到底是哪条路多少号。</p> <h2 id="dns-服务器"><a href="#dns-服务器" aria-hidden="true" class="header-anchor">#</a> DNS 服务器</h2> <p>在网络世界，也是这样的。你肯定记得住网站的名称，但是很难记住网站的 IP 地址，因而也需要一个地址簿，就是DNS 服务器。</p> <p>由此可见，DNS 在日常生活中多么重要。每个人上网，都需要访问它，但是同时，这对它来讲也是非常大的挑战。一旦它出了故障，整个互联网都将瘫痪。另外，上网的人分布在全世界各地，如果大家都去同一个地方访问某一台服务器，时延将会非常大。因而，<strong>DNS 服务器，一定要设置成高可用、高并发和分布式的</strong>。</p> <p>于是，就有了这样树状的层次结构。</p> <!----> <ul><li><p>根 DNS 服务器 ：返回顶级域 DNS 服务器的 IP 地址</p></li> <li><p>顶级域 DNS 服务器：返回权威 DNS 服务器的 IP 地址</p></li> <li><p>权威 DNS 服务器 ：返回相应主机的 IP 地址</p></li></ul> <h2 id="dns-解析流程"><a href="#dns-解析流程" aria-hidden="true" class="header-anchor">#</a> DNS 解析流程</h2> <p>为了提高 DNS 的解析性能，很多网络都会就近部署 DNS 缓存服务器。于是，就有了以下的 DNS 解析流程。</p> <ol><li><p>电脑客户端会发出一个 DNS 请求，问 www.163.com 的 IP 是啥啊，并发给本地域名服务器 (本地 DNS)。那本地域名服务器 (本地 DNS) 是什么呢？如果是通过 DHCP 配置，本地 DNS 由你的网络服务商（ISP），如电信、移动等自动分配，它通常就在你网络服务商的某个机房。</p></li> <li><p>本地 DNS 收到来自客户端的请求。你可以想象这台服务器上缓存了一张域名与之对应 IP 地址的大表格。如果能找到 www.163.com，它直接就返回 IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大，能告诉我 www.163.com 的 IP 地址吗？”根域名服务器是最高层次的，全球共有 13 套。它不直接用于域名解析，但能指明一条道路。</p></li> <li><p>根 DNS 收到来自本地 DNS 的请求，发现后缀是 .com，说：“哦，www.163.com 啊，这个域名是由.com 区域管理，我给你它的顶级域名服务器的地址，你去问问它吧。”</p></li> <li><p>本地 DNS 转向问顶级域名服务器：“老二，你能告诉我 www.163.com 的 IP 地址吗？”顶级域名服务器就是大名鼎鼎的比如 .com、.net、 .org 这些一级域名，它负责管理二级域名，比如 163.com，所以它能提供一条更清晰的方向。</p></li> <li><p>顶级域名服务器说：“我给你负责 www.163.com 区域的权威 DNS 服务器的地址，你去问它应该能问到。”</p></li> <li><p>本地 DNS 转向问权威 DNS 服务器：“您好，www.163.com 对应的 IP 是啥呀？”163.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。</p></li> <li><p>权限 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。</p></li> <li><p>本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。</p></li></ol> <p>至此，我们完成了 DNS 的解析过程。现在总结一下，整个过程我画成了一个图。
<!----></p> <h2 id="负载均衡"><a href="#负载均衡" aria-hidden="true" class="header-anchor">#</a> 负载均衡</h2> <p>站在客户端角度，这是一次DNS 递归查询过程。因为本地 DNS 全权为它效劳，它只要坐等结果即可。在这个过程中，DNS 除了可以通过名称映射为 IP 地址，它还可以做另外一件事，就是负载均衡。</p> <p>还是以访问“外婆家”为例，还是我们开头的“外婆家”，但是，它可能有很多地址，因为它在杭州可以有很多家。所以，如果一个人想去吃“外婆家”，他可以就近找一家店，而不用大家都去同一家，这就是负载均衡。</p> <p>DNS 首先可以做内部负载均衡。</p> <p>例如，一个应用要访问数据库，在这个应用里面应该配置这个数据库的 IP 地址，还是应该配置这个数据库的域名呢？显然应该配置域名，因为一旦这个数据库，因为某种原因，换到了另外一台机器上，而如果有多个应用都配置了这台数据库的话，一换 IP 地址，就需要将这些应用全部修改一遍。但是如果配置了域名，则只要在 DNS 服务器里，将域名映射为新的 IP 地址，这个工作就完成了，大大简化了运维。</p> <p>在这个基础上，我们可以再进一步。例如，某个应用要访问另外一个应用，如果配置另外一个应用的 IP 地址，那么这个访问就是一对一的。但是当被访问的应用撑不住的时候，我们其实可以部署多个。但是，访问它的应用，如何在多个之间进行负载均衡？只要配置成为域名就可以了。在域名解析的时候，我们只要配置策略，这次返回第一个 IP，下次返回第二个 IP，就可以实现负载均衡了。</p> <p>另外一个更加重要的是，DNS 还可以做全局负载均衡。</p> <p>为了保证我们的应用高可用，往往会部署在多个机房，每个地方都会有自己的 IP 地址。当用户访问某个域名的时候，这个 IP 地址可以轮询访问多个数据中心。如果一个数据中心因为某种原因挂了，只要在 DNS 服务器里面，将这个数据中心对应的 IP 地址删除，就可以实现一定的高可用。</p> <p>另外，我们肯定希望北京的用户访问北京的数据中心，上海的用户访问上海的数据中心，这样，客户体验就会非常好，访问速度就会超快。这就是全局负载均衡的概念。</p> <h3 id="示例：dns-访问数据中心中对象存储上的静态资源"><a href="#示例：dns-访问数据中心中对象存储上的静态资源" aria-hidden="true" class="header-anchor">#</a> 示例：DNS 访问数据中心中对象存储上的静态资源</h3> <p>我们通过 DNS 访问数据中心中对象存储上的静态资源为例，看一看整个过程。</p> <p>假设全国有多个数据中心，托管在多个运营商，每个数据中心三个可用区（Available Zone）。对象存储通过跨可用区部署，实现高可用性。在每个数据中心中，都至少部署两个内部负载均衡器，内部负载均衡器后面对接多个对象存储的前置服务器（Proxy-server）。</p> <!----> <ol><li><p>当一个客户端要访问 object.yourcompany.com 的时候，需要将域名转换为 IP 地址进行访问，所以它要请求本地 DNS 解析器。</p></li> <li><p>本地 DNS 解析器先查看看本地的缓存是否有这个记录。如果有则直接使用，因为上面的过程太复杂了，如果每次都要递归解析，就太麻烦了。</p></li> <li><p>如果本地无缓存，则需要请求本地的 DNS 服务器。</p></li> <li><p>本地的 DNS 服务器一般部署在你的数据中心或者你所在的运营商的网络中，本地 DNS 服务器也需要看本地是否有缓存，如果有则返回，因为它也不想把上面的递归过程再走一遍。</p></li> <li><p>至 7. 如果本地没有，本地 DNS 才需要递归地从根 DNS 服务器，查到.com 的顶级域名服务器，最终查到 yourcompany.com 的权威 DNS 服务器，给本地 DNS 服务器，权威 DNS 服务器按说会返回真实要访问的 IP 地址。</p></li></ol> <p>对于不需要做全局负载均衡的简单应用来讲，yourcompany.com 的权威 DNS 服务器可以直接将 object.yourcompany.com 这个域名解析为一个或者多个 IP 地址，然后客户端可以通过多个 IP 地址，进行简单的轮询，实现简单的负载均衡。</p> <p>但是对于复杂的应用，尤其是跨地域跨运营商的大型应用，则需要更加复杂的全局负载均衡机制，因而需要专门的设备或者服务器来做这件事情，这就是 <strong>全局负载均衡器（GSLB，Global Server Load Balance）</strong>。</p> <p>在 yourcompany.com 的 DNS 服务器中，一般是通过配置 CNAME 的方式，给 object.yourcompany.com 起一个别名，例如 object.vip.yourcomany.com，然后告诉本地 DNS 服务器，让它请求 GSLB 解析这个域名，GSLB 就可以在解析这个域名的过程中，通过自己的策略实现负载均衡。</p> <p>图中画了两层的 GSLB，是因为分运营商和地域。我们希望不同运营商的客户，可以访问相同运营商机房中的资源，这样不跨运营商访问，有利于提高吞吐量，减少时延。</p> <ol><li><p>第一层 GSLB，通过查看请求它的本地 DNS 服务器所在的运营商，就知道用户所在的运营商。假设是移动，通过 CNAME 的方式，通过另一个别名 object.yd.yourcompany.com，告诉本地 DNS 服务器去请求第二层的 GSLB。</p></li> <li><p>第二层 GSLB，通过查看请求它的本地 DNS 服务器所在的地址，就知道用户所在的地理位置，然后将距离用户位置比较近的 Region 里面，六个内部负载均衡（SLB，Server Load Balancer）的地址，返回给本地 DNS 服务器。</p></li> <li><p>本地 DNS 服务器将结果返回给本地 DNS 解析器。</p></li> <li><p>本地 DNS 解析器将结果缓存后，返回给客户端。</p></li> <li><p>客户端开始访问属于相同运营商的距离较近的 Region 1 中的对象存储，当然客户端得到了六个 IP 地址，它可以通过负载均衡的方式，随机或者轮询选择一个可用区进行访问。对象存储一般会有三个备份，从而可以实现对存储读写的负载均衡。</p></li></ol> <h2 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h2> <p>好了，这节内容就到这里了，我们来总结一下：</p> <ul><li><p>DNS 是网络世界的地址簿，可以通过域名查地址，因为域名服务器是按照树状结构组织的，因而域名查找是使用递归的方法，并通过缓存的方式增强性能；</p></li> <li><p>在域名和 IP 的映射过程中，给了应用基于域名做负载均衡的机会，可以是简单的负载均衡，也可以根据地址和运营商做全局的负载均衡。</p></li></ul> <p>最后，给你留两个思考题：</p> <ol><li><p>全局负载均衡为什么要分地址和运营商呢？</p></li> <li><p>全局负载均衡使用过程中，常常遇到失灵的情况，你知道具体有哪些情况吗？对应应该怎么来解决呢？</p></li></ol></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/netLearn/lesson17.html" class="prev">
          P2P协议
        </a></span> <span class="next"><a href="/netLearn/lesson19.html">
          HTTPDNS
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/netLearn/assets/js/31.e9226cac.js" defer></script><script src="/netLearn/assets/js/app.2914d2f8.js" defer></script>
  </body>
</html>
