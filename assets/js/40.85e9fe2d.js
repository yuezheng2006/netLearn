(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{65:function(t,s,a){"use strict";a.r(s);var n=a(1),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),a("ClientOnly",[a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/d5/ec/d5b10854a6673a22557a465d7c03b3ec.jpg"}})],1),t._v(" "),a("p",[t._v("《圣经》中有一个通天塔的故事，大致是说，上帝为了阻止人类联合起来，就让人类说不同的语言。人类没法儿沟通，达不成“协议”，通天塔的计划就失败了。")]),t._v(" "),a("p",[t._v("但是千年以后，有一种叫“程序猿”的物种，敲着一种这个群体通用的语言，连接着全世界所有的人，打造这互联网世界的通天塔。如今的世界，正是因为互联网，才连接在一起。")]),t._v(" "),a("p",[t._v('当 "Hello World!" 从显示器打印出来的时候，还记得你激动的心情吗？')]),t._v(" "),t._m(2),a("p",[t._v("如果你是程序员，一定看得懂上面这一段文字。这是每一个程序员向计算机世界说“你好，世界”的方式。但是，你不一定知道，这段文字也是一种协议，是人类和计算机沟通的协议，只有通过这种协议，计算机才知道我们想让它做什么。")]),t._v(" "),a("ClientOnly",[a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/47/7a/47f340b2d76fd29bb937006f19dd3e7a.png"}})],1),t._v(" "),t._m(3),t._v(" "),a("p",[t._v("当然，这种协议还是更接近人类语言，机器不能直接读懂，需要进行翻译，翻译的工作教给编译器，也就是程序员常说的 compile。这个过程比较复杂，其中的编译原理非常复杂，我在这里不进行详述。")]),t._v(" "),a("p",[t._v("但是可以看得出，计算机语言作为程序员控制一台计算机工作的协议，具备了协议的三要素。")]),t._v(" "),t._m(4),t._v(" "),a("p",[t._v("会了计算机语言，你就能够教给一台计算机完成你的工作了。恭喜你，入门了！")]),t._v(" "),t._m(5),t._v(" "),a("p",[t._v("这个时候，你可能会问，网络协议长啥样，这么神奇，能干成啥事？我先拿一个简单的例子，让你尝尝鲜，然后再讲一个大事。")]),t._v(" "),a("p",[t._v("当你想要买一个商品，常规的做法就是打开浏览器，输入购物网站的地址。浏览器就会给你显示一个缤纷多彩的页面。")]),t._v(" "),a("p",[t._v("那你有没有深入思考过，浏览器是如何做到这件事情的？它之所以能够显示缤纷多彩的页面，是因为它收到了一段来自 HTTP 协议的“东西”。我拿网易考拉来举例，格式就像下面这样：")]),t._v(" "),t._m(6),a("p",[t._v("这符合协议的三要素吗？我带你来看一下。")]),t._v(" "),a("p",[t._v("首先，符合语法，也就是说，只有按照上面那个格式来，浏览器才认。例如，上来是状态，然后是首部，然后是内容。")]),t._v(" "),a("p",[t._v("第二，符合语义，就是要按照约定的意思来。例如，状态 200，表述的意思是网页成功返回。如果不成功，就是我们常见的“404”。")]),t._v(" "),a("p",[t._v("第三，符合顺序，你一点浏览器，就是发送出一个 HTTP 请求，然后才有上面那一串 HTTP 返回的东西。")]),t._v(" "),a("p",[t._v("浏览器显然按照协议商定好的做了，最后一个五彩缤纷的页面就出现在你面前了。")]),t._v(" "),a("p",[t._v("我们常用的网络协议有哪些？\n接下来揭秘我要说的大事情，“双十一”。这和我们要讲的网络协议有什么关系呢？")]),t._v(" "),a("p",[t._v("在经济学领域，有个伦纳德·里德（Leonard E. Read）创作的《铅笔的故事》。这个故事通过一个铅笔的诞生过程，来讲述复杂的经济学理论。这里，我也用一个下单的过程，看看互联网世界的运行过程中，都使用了哪些网络协议。")]),t._v(" "),a("p",[t._v("你先在浏览器里面输入 "),a("a",{attrs:{href:"https://www.kaola.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.kaola.com"),a("OutboundLink")],1),t._v(" ，这是一个 URL。浏览器只知道名字是“www.kaola.com”，但是不知道具体的地点，所以不知道应该如何访问。于是，它打开 "),a("strong",[t._v("地址簿")]),t._v("去查找。可以使用一般的地址簿协议 DNS 去查找，还可以使用另一种更加精准的地址簿查找协议 HTTPDNS。")]),t._v(" "),t._m(7),t._v(" "),a("p",[t._v("知道了目标地址，浏览器就开始打包它的请求。对于普通的浏览请求，往往会使用 HTTP 协议；但是对于购物的请求，往往需要进行加密传输，因而会使用 HTTPS 协议。无论是什么协议，里面都会写明“你要买什么和买多少”。\n"),a("ClientOnly",[a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/d8/c6/d8a65ca347ad26acc9f1de49b10320c6.png"}})],1)],1),t._v(" "),t._m(8),t._v(" "),a("p",[t._v("TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是电商的服务器监听的端口。操作系统往往通过端口来判断，它得到的包应该给哪个进程。")]),t._v(" "),a("ClientOnly",[a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/53/ee/53c753a7d49c9dfe3cfeb26497e47eee.png"}})],1),t._v(" "),t._m(9),t._v(" "),a("ClientOnly",[a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/45/1b/459a421975b27f6187d2aa4673171f1b.png"}})],1),t._v(" "),a("p",[t._v("操作系统既然知道了目标 IP 地址，就开始想如何根据这个门牌号找到目标机器。操作系统往往会判断，这个目标 IP 地址是本地人，还是外地人。如果是本地人，从门牌号就能看出来，但是显然电商网站不在本地，而在遥远的地方。")]),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),a("ClientOnly",[a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/cc/4f/cc02190ac57af7fb6c3839534f2b674f.png"}})],1),t._v(" "),a("p",[t._v("于是操作系统将 IP 包交给了下一层，也就是 MAC 层。网卡再将包发出去。由于这个包里面是有 MAC 地址的，因而它能到达网关。")]),t._v(" "),t._m(12),t._v(" "),a("p",[t._v("路由器有点像玄奘西行路过的一个个国家的一个个城关。每个城关都连着两个国家，每个国家相当于一个局域网，在每个国家内部，都可以使用本地的地址 MAC 进行通信。")]),t._v(" "),a("p",[t._v("一旦跨越城关，就需要拿出 IP 头来，里面写着贫僧来自东土大唐（就是源 IP 地址），欲往西天拜佛求经（指的是目标 IP 地址）。路过宝地，借宿一晚，明日启行，请问接下来该怎么走啊？\n"),a("ClientOnly",[a("br"),t._v(" "),a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/f7/e2/f7ea602aec91c67b35e710fb72a975e2.png"}})],1)],1),t._v(" "),t._m(13),t._v(" "),a("ClientOnly",[a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/b2/d4/b25ad7afba7b79331d95875dd0f451d4.png"}})],1),t._v(" "),a("p",[t._v("城关与城关之间是一个国家，当网络包知道了下一步去哪个城关，还是要使用国家内部的 MAC 地址，通过下一个城关的 MAC 地址，找到下一个城关，然后再问下一步的路怎么走，一直到走出最后一个城关。")]),t._v(" "),a("p",[t._v("最后一个城关知道这个网络包要去的地方。于是，对着这个国家吼一声，谁是目标 IP 啊？目标服务器就会回复一个 MAC 地址。网络包过关后，通过这个 MAC 地址就能找到目标服务器。")]),t._v(" "),a("p",[t._v("目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也对上了，就取下 IP 头。IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即 TCP 层。")]),t._v(" "),a("p",[t._v("在这一层里，对于收到的每个包，都会有一个回复的包说明收到了。这个回复的包绝非这次下单请求的结果，例如购物是否成功，扣了多少钱等，而仅仅是 TCP 层的一个说明，即收到之后的回复。当然这个回复，会沿着刚才来的方向走回去，报个平安。")]),t._v(" "),a("p",[t._v("因为一旦出了国门，西行路上千难万险，如果在这个过程中，网络包走丢了，例如进了大沙漠，或者被强盗抢劫杀害怎么办呢？因而到了要报个平安。")]),t._v(" "),a("p",[t._v("如果过一段时间还是没到，发送端的 TCP 层会重新发送这个包，还是上面的过程，直到有一天收到平安到达的回复。这个重试绝非你的浏览器重新将下单这个动作重新请求一次。对于浏览器来讲，就发送了一次下单请求，TCP 层不断自己闷头重试。除非 TCP 这一层出了问题，例如连接断了，才轮到浏览器的应用层重新发送下单请求。")]),t._v(" "),a("p",[t._v("当网络包平安到达 TCP 层之后，TCP 头中有目标端口号，通过这个端口号，可以找到电商网站的进程正在监听这个端口号，假设一个 Tomcat，将这个包发给电商网站。\n"),a("ClientOnly",[a("br"),t._v(" "),a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/b4/3f/b465ccfafe333bfdfb9daf78f96e123f.png"}})],1)],1),t._v(" "),a("p",[t._v("电商网站的进程得到 HTTP 请求的内容，知道了要买东西，买多少。往往一个电商网站最初接待请求的这个 Tomcat 只是个接待员，负责统筹处理这个请求，而不是所有的事情都自己做。例如，这个接待员要告诉专门管理订单的进程，登记要买某个商品，买多少，要告诉管理库存的进程，库存要减少多少，要告诉支付的进程，应该付多少钱，等等。")]),t._v(" "),a("p",[t._v("如何告诉相关的进程呢？往往通过 RPC 调用，即远程过程调用的方式来实现。远程过程调用就是当告诉管理订单进程的时候，接待员不用关心中间的网络互连问题，会由 RPC 框架统一处理。RPC 框架有很多种，有基于 HTTP 协议放在 HTTP 的报文里面的，有直接封装在 TCP 报文里面的。")]),t._v(" "),a("p",[t._v("当接待员发现相应的部门都处理完毕，就回复一个 HTTPS 的包，告知下单成功。这个 HTTPS 的包，会像来的时候一样，经过千难万险到达你的个人电脑，最终进入浏览器，显示支付成功。")]),t._v(" "),t._m(14),t._v(" "),a("p",[t._v("看到了吧，一个简简单单的下单过程，中间牵扯到这么多的协议。而管理一大片机器，更是一件特别有技术含量的事情。除此之外，像最近比较火的云计算、容器、微服务等技术，也都需要借助各种协议，来达成大规模机器之间的合作。")]),t._v(" "),a("p",[t._v("我在这里列一下之后要讲的网络协议，之后我会按照从底层到上层的顺序来讲述。\n"),a("ClientOnly",[a("br"),t._v(" "),a("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/af/34/afde9b4b90ee1c43c53948ab85fd6734.jpg"}})],1)],1),t._v(" "),a("p",[t._v("上面的“双十一”故事只是为了给你一个大致的框架，这里面有些协议，我在故事里已经提到了，有些还没有提到。在这门课的最后一章，当所有的协议都讲过之后，我会再重新讲一遍这个故事，到时候你就能明白更多的细节。")]),t._v(" "),a("p",[t._v("最后，学完了这一节，给你留一个问题吧。")]),t._v(" "),t._m(15)],1)},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"第-1-讲-为什么要学习网络协议？"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第-1-讲-为什么要学习网络协议？","aria-hidden":"true"}},[this._v("#")]),this._v(" 第 1 讲 | 为什么要学习网络协议？")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("2018-05-18 刘超")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("HelloWorld")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("main")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("String"),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    System"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("println")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v('"Hello World!"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"协议三要素"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#协议三要素","aria-hidden":"true"}},[this._v("#")]),this._v(" 协议三要素")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[a("p",[a("strong",[t._v("语法")]),t._v("，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("语义")]),t._v("，就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("顺序")]),t._v("，就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("但是，要想打造互联网世界的通天塔，只教给一台机器做什么是不够的，你需要学会教给一大片机器做什么。这就需要网络协议。"),s("strong",[this._v("只有通过网络协议，才能使一大片机器互相协作、共同完成一件事。")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[t._v("HTTP/1.1 200 OK\nDate: Tue, 27 Mar 2018 16:50:26 GMT\nContent-Type: text/html;charset=UTF-8\nContent-Language: zh-CN\n\n"),a("span",{attrs:{class:"token doctype"}},[t._v("<!DOCTYPE html>")]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("head")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("base")]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("href")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')]),t._v("https://pages.kaola.com/"),a("span",{attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("meta")]),t._v(" "),a("span",{attrs:{class:"token attr-name"}},[t._v("charset")]),a("span",{attrs:{class:"token attr-value"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{attrs:{class:"token punctuation"}},[t._v('"')]),t._v("utf-8"),a("span",{attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" "),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("title")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" 网易考拉 3 周年主会场 "),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("title")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("无论用哪一种方法查找，最终都会得到这个地址：106.114.138.24。这个是 "),s("strong",[this._v("IP 地址")]),this._v("，是互联网世界的“门牌号”。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("DNS、HTTP、HTTPS 所在的层我们称为应用层。")]),this._v(" 经过应用层封装后，浏览器会将应用层的包交给下一层去完成，通过 socket 编程来实现。下一层是传输层。传输层有两种协议，一种是无连接的协议 UDP，一种是面向连接的协议 TCP。对于支付来讲，往往使用 TCP 协议。所谓的面向连接就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("传输层封装完毕后，浏览器会将包交给操作系统的网络层。网络层的协议是 IP 协议。在 IP 协议里面会有 "),s("strong",[this._v("源 IP 地址")]),this._v("，即浏览器所在机器的 IP 地址和目标 IP 地址，也即电商网站所在服务器的 IP 地址。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("操作系统知道要离开本地去远方。虽然不知道远方在何处，但是可以这样类比一下：如果去国外要去海关，去外地就要去网关。而操作系统启动的时候，就会被 "),s("strong",[this._v("DHCP 协议")]),this._v("配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("操作系统如何将 IP 地址发给网关呢？在本地通信基本靠吼，于是操作系统大吼一声，谁是 192.168.1.1 啊？网关会回答它，我就是，我的本地地址在村东头。这个本地地址就是 "),s("strong",[this._v("MAC 地址")]),this._v("，而大吼的那一声是 ARP 协议。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("网关收到包之后，会根据自己的知识，判断下一步应该怎么走。网关往往是一个路由器，到某个 IP 地址应该怎么走，这个叫作 "),s("strong",[this._v("路由表")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("城关往往是知道这些“知识”的，因为城关和临近的城关也会经常沟通。到哪里应该怎么走，这种沟通的协议称为 "),s("strong",[this._v("路由协议")]),this._v("，常用的有 "),s("strong",[this._v("OSPF 和 BGP")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"小结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小结","aria-hidden":"true"}},[this._v("#")]),this._v(" 小结")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("当网络包到达一个城关的时候，可以通过路由表得到下一个城关的 IP 地址，直接通过 IP 地址找就可以了，为什么还要通过本地的 MAC 地址呢？")])])}],!1,null,null,null);s.default=e.exports}}]);