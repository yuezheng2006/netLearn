(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{97:function(t,e,s){"use strict";s.r(e);var a=s(1),n=Object(a.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/4e/93/4e4b432837b091c064bc3ef23a4b0093.jpg"}})],1),t._v(" "),s("p",[t._v("上一节，我们讲了 IP 的一些基本概念。如果需要和其他机器通讯，我们就需要一个通讯地址，我们需要给网卡配置这么一个地址。")]),t._v(" "),t._m(2),t._v(" "),s("p",[t._v("那如何配置呢？如果有相关的知识和积累，你可以用命令行自己配置一个地址。可以使用 ifconfig，也可以使用 ip addr。设置好了以后，用这两个命令，将网卡 up 一下，就可以开始工作了。")]),t._v(" "),t._m(3),t._v(" "),t._m(4),t._m(5),t._v(" "),t._m(6),s("p",[t._v("你可能会问了，自己配置这个自由度太大了吧，我是不是配置什么都可以？如果配置一个和谁都不搭边的地址呢？例如，旁边的机器都是 192.168.1.x，我非得配置一个 16.158.23.6，会出现什么现象呢？")]),t._v(" "),s("p",[t._v("不会出现任何现象，就是包发不出去呗。为什么发不出去呢？我来举例说明。")]),t._v(" "),s("p",[t._v("192.168.1.6 就在你这台机器的旁边，甚至是在同一个交换机上，而你把机器的地址设为了 16.158.23.6。在这台机器上，你企图去 ping192.168.1.6，你觉得只要将包发出去，同一个交换机的另一台机器马上就能收到，对不对？")]),t._v(" "),s("p",[t._v("可是 Linux 系统不是这样的，它没你想得那么智能。你用肉眼看到那台机器就在旁边，它则需要根据自己的逻辑进行处理。")]),t._v(" "),t._m(7),t._v(" "),s("p",[t._v("所以，你看着它有自己的源 IP 地址 16.158.23.6，也有目标 IP 地址 192.168.1.6，但是包发不出去，这是因为 MAC 层还没填。")]),t._v(" "),s("p",[t._v("自己的 MAC 地址自己知道，这个容易。但是目标 MAC 填什么呢？是不是填 192.168.1.6 这台机器的 MAC 地址呢？")]),t._v(" "),s("p",[t._v("当然不是。Linux 首先会判断，要去的这个地址和我是一个网段的吗，或者和我的一个网卡是同一网段的吗？只有是一个网段的，它才会发送 ARP 请求，获取 MAC 地址。如果发现不是呢？")]),t._v(" "),t._m(8),t._v(" "),s("p",[t._v("如果你配置了网关的话，Linux 会获取网关的 MAC 地址，然后将包发出去。对于 192.168.1.6 这台机器来讲，虽然路过它家门的这个包，目标 IP 是它，但是无奈 MAC 地址不是它的，所以它的网卡是不会把包收进去的。")]),t._v(" "),s("p",[t._v("如果没有配置网关呢？那包压根就发不出去。")]),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),s("p",[t._v("原来配置 IP 有这么多门道儿啊。你可能会问了，配置了 IP 之后一般不能变的，配置一个服务端的机器还可以，但是如果是客户端的机器呢？我抱着一台笔记本电脑在公司里走来走去，或者白天来晚上走，每次使用都要配置 IP 地址，那可怎么办？还有人事、行政等非技术人员，如果公司所有的电脑都需要 IT 人员配置，肯定忙不过来啊。")]),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),s("p",[t._v("所以说，如果是数据中心里面的服务器，IP 一旦配置好，基本不会变，这就相当于买房自己装修。DHCP 的方式就相当于租房。你不用装修，都是帮你配置好的。你暂时用一下，用完退租就可以了。")]),t._v(" "),t._m(14),t._v(" "),s("p",[t._v("当一台机器新加入一个网络的时候，肯定一脸懵，啥情况都不知道，只知道自己的 MAC 地址。怎么办？先吼一句，我来啦，有人吗？这时候的沟通基本靠“吼”。这一步，我们称为 DHCP Discover。")]),t._v(" "),s("p",[t._v("新来的机器使用 IP 地址 0.0.0.0 发送了一个广播包，目的 IP 地址为 255.255.255.255。广播包封装在 UDP 里面，UDP 封装在 BOOTP 里面。其实 DHCP 是 BOOTP 的增强版，但是如果你去抓包的话，很可能看到的名称还是 BOOTP 协议。")]),t._v(" "),s("p",[t._v("在这个广播包里面，新人大声喊：我是新来的（Boot request），我的 MAC 地址是这个，我还没有 IP，谁能给租给我个 IP 地址！")]),t._v(" "),s("p",[t._v("格式就像这样：")]),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/39/1f/395b304f49559034af34c882bd86f11f.jpg"}})],1),t._v(" "),t._m(15),t._v(" "),s("p",[t._v("只有 MAC 唯一，IP 管理员才能知道这是一个新人，需要租给它一个 IP 地址，这个过程我们称为 DHCP Offer。同时，DHCP Server 为此客户保留为它提供的 IP 地址，从而不会为其他 DHCP 客户分配此 IP 地址。")]),t._v(" "),s("p",[t._v("DHCP Offer 的格式就像这样，里面有给新人分配的地址。")]),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/54/86/54ffefbe4f493f0f4a39f45504bd5086.jpg"}})],1),t._v(" "),s("p",[t._v("DHCP Server 仍然使用广播地址作为目的地址，因为，此时请求分配 IP 的新人还没有自己的 IP。DHCP Server 回复说，我分配了一个可用的 IP 给你，你看如何？除此之外，服务器还发送了子网掩码、网关和 IP 地址租用期等信息。")]),t._v(" "),s("p",[t._v("新来的机器很开心，它的“吼”得到了回复，并且有人愿意租给它一个 IP 地址了，这意味着它可以在网络上立足了。当然更令人开心的是，如果有多个 DHCP Server，这台新机器会收到多个 IP 地址，简直受宠若惊。")]),t._v(" "),s("p",[t._v("它会选择其中一个 DHCP Offer，一般是最先到达的那个，并且会向网络发送一个 DHCP Request 广播数据包，包中包含客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址等，并告诉所有 DHCP Server 它将接受哪一台服务器提供的 IP 地址，告诉其他 DHCP 服务器，谢谢你们的接纳，并请求撤销它们提供的 IP 地址，以便提供给下一个 IP 租用请求者。")]),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/e1/24/e1e45ba0d86d2774ec80a1d86f87b724.jpg"}})],1),t._v(" "),s("p",[t._v("此时，由于还没有得到 DHCP Server 的最后确认，客户端仍然使用 0.0.0.0 为源 IP 地址、255.255.255.255 为目标地址进行广播。在 BOOTP 里面，接受某个 DHCP Server 的分配的 IP。")]),t._v(" "),s("p",[t._v("当 DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。")]),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/7d/0e/7da571c18b974582a9cfe4718c5dea0e.jpg"}})],1),t._v(" "),s("p",[t._v("最终租约达成的时候，还是需要广播一下，让大家都知道。")]),t._v(" "),t._m(16),t._v(" "),s("p",[t._v("既然是租房子，就是有租期的。租期到了，管理员就要将 IP 收回。")]),t._v(" "),s("p",[t._v("如果不用的话，收回就收回了。就像你租房子一样，如果还要续租的话，不能到了时间再续租，而是要提前一段时间给房东说。DHCP 也是这样。")]),t._v(" "),s("p",[t._v("客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。")]),t._v(" "),s("p",[t._v("好了，一切看起来完美。DHCP 协议大部分人都知道，但是其实里面隐藏着一个细节，很多人可能不会去注意。接下来，我就讲一个有意思的事情：网络管理员不仅能自动分配 IP 地址，还能帮你自动安装操作系统！")]),t._v(" "),t._m(17),t._v(" "),s("p",[t._v("普通的笔记本电脑，一般不会有这种需求。因为你拿到电脑时，就已经有操作系统了，即便你自己重装操作系统，也不是很麻烦的事情。但是，在数据中心里就不一样了。数据中心里面的管理员可能一下子就拿到几百台空的机器，一个个安装操作系统，会累死的。")]),t._v(" "),s("p",[t._v("所以管理员希望的不仅仅是自动分配 IP 地址，还要自动安装系统。装好系统之后自动分配 IP 地址，直接启动就能用了，这样当然最好了！")]),t._v(" "),s("p",[t._v("这事儿其实仔细一想，还是挺有难度的。安装操作系统，应该有个光盘吧。数据中心里不能用光盘吧，想了一个办法就是，可以将光盘里面要安装的操作系统放在一个服务器上，让客户端去下载。但是客户端放在哪里呢？它怎么知道去哪个服务器上下载呢？客户端总得安装在一个操作系统上呀，可是这个客户端本来就是用来安装操作系统的呀？")]),t._v(" "),s("p",[t._v("其实，这个过程和操作系统启动的过程有点儿像。首先，启动 BIOS。这是一个特别小的小系统，只能干特别小的一件事情。其实就是读取硬盘的 MBR 启动扇区，将 GRUB 启动起来；然后将权力交给 GRUB，GRUB 加载内核、加载作为根文件系统的 initramfs 文件；然后将权力交给内核；最后内核启动，初始化整个操作系统。")]),t._v(" "),t._m(18),t._v(" "),s("p",[t._v("PXE 协议分为客户端和服务器端，由于还没有操作系统，只能先把客户端放在 BIOS 里面。当计算机启动时，BIOS 把 PXE 客户端调入内存里面，就可以连接到服务端做一些操作了。")]),t._v(" "),s("p",[t._v("首先，PXE 客户端自己也需要有个 IP 地址。因为 PXE 的客户端启动起来，就可以发送一个 DHCP 的请求，让 DHCP Server 给它分配一个地址。PXE 客户端有了自己的地址，那它怎么知道 PXE 服务器在哪里呢？对于其他的协议，都好办，要么人告诉他。例如，告诉浏览器要访问的 IP 地址，或者在配置中告诉它；例如，微服务之间的相互调用。")]),t._v(" "),s("p",[t._v("但是 PXE 客户端启动的时候，啥都没有。好在 DHCP Server 除了分配 IP 地址以外，还可以做一些其他的事情。这里有一个 DHCP Server 的一个样例配置：")]),t._v(" "),t._m(19),s("p",[t._v("按照上面的原理，默认的 DHCP Server 是需要配置的，无非是我们配置 IP 的时候所需要的 IP 地址段、子网掩码、网关地址、租期等。如果想使用 PXE，则需要配置 next-server，指向 PXE 服务器的地址，另外要配置初始启动文件 filename。")]),t._v(" "),s("p",[t._v("这样 PXE 客户端启动之后，发送 DHCP 请求之后，除了能得到一个 IP 地址，还可以知道 PXE 服务器在哪里，也可以知道如何从 PXE 服务器上下载某个文件，去初始化操作系统。")]),t._v(" "),t._m(20),t._v(" "),s("p",[t._v("接下来我们来详细看一下 PXE 的工作过程。")]),t._v(" "),s("p",[t._v("首先，启动 PXE 客户端。第一步是通过 DHCP 协议告诉 DHCP Server，我刚来，一穷二白，啥都没有。DHCP Server 便租给它一个 IP 地址，同时也给它 PXE 服务器的地址、启动文件 pxelinux.0。")]),t._v(" "),s("p",[t._v("其次，PXE 客户端知道要去 PXE 服务器下载这个文件后，就可以初始化机器。于是便开始下载，下载的时候使用的是 TFTP 协议。所以 PXE 服务器上，往往还需要有一个 TFTP 服务器。PXE 客户端向 TFTP 服务器请求下载这个文件，TFTP 服务器说好啊，于是就将这个文件传给它。")]),t._v(" "),s("p",[t._v("然后，PXE 客户端收到这个文件后，就开始执行这个文件。这个文件会指示 PXE 客户端，向 TFTP 服务器请求计算机的配置信息 pxelinux.cfg。TFTP 服务器会给 PXE 客户端一个配置文件，里面会说内核在哪里、initramfs 在哪里。PXE 客户端会请求这些文件。")]),t._v(" "),s("p",[t._v("最好，启动 Linux 内核。一旦启动了操作系统，以后就啥都好办了。")]),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/6e/a4/6e69007db3fc68ff6da8496266abf6a4.jpg"}})],1),t._v(" "),t._m(21),t._v(" "),s("p",[t._v("好了，这一节就到这里了。我来总结一下今天的内容：")]),t._v(" "),t._m(22),t._v(" "),s("p",[t._v("最后，学完了这一节，给你留两个思考题吧。")]),t._v(" "),t._m(23)],1)},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"第-4-讲-dhcp-与-pxe：ip-是怎么来的，又是怎么没的？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第-4-讲-dhcp-与-pxe：ip-是怎么来的，又是怎么没的？","aria-hidden":"true"}},[this._v("#")]),this._v(" 第 4 讲 | DHCP 与 PXE：IP 是怎么来的，又是怎么没的？")])},function(){var t=this.$createElement,e=this._self._c||t;return e("blockquote",[e("p",[this._v("2018-05-25 刘超")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"如何配置-ip-地址？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何配置-ip-地址？","aria-hidden":"true"}},[this._v("#")]),this._v(" 如何配置 IP 地址？")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"使用-net-tools："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-net-tools：","aria-hidden":"true"}},[this._v("#")]),this._v(" 使用 net-tools：")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ "),s("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{attrs:{class:"token function"}},[t._v("ifconfig")]),t._v(" eth1 10.0.0.1/24\n$ "),s("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{attrs:{class:"token function"}},[t._v("ifconfig")]),t._v(" eth1 up\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"使用-iproute2："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-iproute2：","aria-hidden":"true"}},[this._v("#")]),this._v(" 使用 iproute2：")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ "),s("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ip addr add 10.0.0.1/24 dev eth1\n$ "),s("span",{attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ip "),s("span",{attrs:{class:"token function"}},[t._v("link")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("set")]),t._v(" up eth1\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("还记得我们在第二节说过的原则吗？"),e("strong",[this._v("只要是在网络上跑的包，都是完整的，可以有下层没上层，绝对不可能有上层没下层")]),this._v("。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("strong",[this._v("Linux 默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("如果将网关配置为 192.168.1.6 呢？不可能，Linux 不会让你配置成功的，因为 "),e("strong",[this._v("网关要和当前的网络至少一个网卡是同一个网段的")]),this._v("，怎么可能 16.158.23.6 的网关是 192.168.1.6 呢？")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("所以，当你需要手动配置一台机器的网络 IP 时，一定要好好问问你的网络管理员。如果在机房里面，要去网络管理员那里申请，让他给你分配一段正确的 IP 地址。当然，真正配置的时候，一定不是直接用命令配置的，而是放在一个配置文件里面。"),e("strong",[this._v("不同系统的配置文件格式不同，但是无非就是 CIDR、子网掩码、广播地址和网关地址。")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"动态主机配置协议（dhcp）"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#动态主机配置协议（dhcp）","aria-hidden":"true"}},[this._v("#")]),this._v(" 动态主机配置协议（DHCP）")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("因此，我们需要有一个自动配置的协议，也就是称 "),e("strong",[this._v("动态主机配置协议（Dynamic Host Configuration Protocol），简称 DHCP")]),this._v("。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("有了这个协议，网络管理员就轻松多了。他只需要 "),e("strong",[this._v("配置一段共享的 IP 地址")]),this._v("。每一台新接入的机器都通过 DHCP 协议，来这个共享的 IP 地址里申请，然后自动配置好就可以了。等人走了，或者用完了，还回去，这样其他的机器也能用。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"解析-dhcp-的工作方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解析-dhcp-的工作方式","aria-hidden":"true"}},[this._v("#")]),this._v(" 解析 DHCP 的工作方式")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("如果一个网络管理员在网络里面配置了 "),e("strong",[this._v("DHCP Server")]),this._v("的话，他就相当于这些 IP 的管理员。他立刻能知道来了一个“新人”。这个时候，我们可以体会 MAC 地址唯一的重要性了。当一台机器带着自己的 MAC 地址加入一个网络的时候，MAC 是它唯一的身份，如果连这个都重复了，就没办法配置了。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"ip-地址的收回和续租"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-地址的收回和续租","aria-hidden":"true"}},[this._v("#")]),this._v(" IP 地址的收回和续租")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"预启动执行环境（pxe）"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#预启动执行环境（pxe）","aria-hidden":"true"}},[this._v("#")]),this._v(" 预启动执行环境（PXE）")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("那我们安装操作系统的过程，只能插在 BIOS 启动之后了。因为没安装系统之前，连启动扇区都没有。因而这个过程叫做 "),e("strong",[this._v("预启动执行环境（Pre-boot Execution Environment），简称 PXE")]),this._v("。")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("ddns-update-style interim"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nignore client-updates"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nallow booting"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nallow bootp"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nsubnet 192.168.1.0 netmask 255.255.255.0\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\noption routers 192.168.1.1"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\noption subnet-mask 255.255.255.0"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\noption time-offset -18000"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ndefault-lease-time 21600"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmax-lease-time 43200"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrange dynamic-bootp 192.168.1.240 192.168.1.250"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfilename "),s("span",{attrs:{class:"token string"}},[t._v('"pxelinux.0"')]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nnext-server 192.168.1.180"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"解析-pxe-的工作过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解析-pxe-的工作过程","aria-hidden":"true"}},[this._v("#")]),this._v(" 解析 PXE 的工作过程")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小结","aria-hidden":"true"}},[this._v("#")]),this._v(" 小结")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("DHCP 协议主要是用来给客户租用 IP 地址，和房产中介很像，要商谈、签约、续租，广播还不能“抢单”；")])]),this._v(" "),e("li",[e("p",[this._v("DHCP 协议能给客户推荐“装修队”PXE，能够安装操作系统，这个在云计算领域大有用处。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[this._v("PXE 协议可以用来安装操作系统，但是如果每次重启都安装操作系统，就会很麻烦。你知道如何使得第一次安装操作系统，后面就正常启动吗？")]),this._v(" "),e("li",[this._v("现在上网很简单了，买个家用路由器，连上 WIFI，给 DHCP 分配一个 IP 地址，就可以上网了。那你是否用过更原始的方法自己组过简单的网呢？说来听听。")])])}],!1,null,null,null);e.default=n.exports}}]);