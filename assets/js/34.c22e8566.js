(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{102:function(t,e,s){"use strict";s.r(e);var i=s(1),_=Object(i.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/10/a1/10c730ee5b805a6b0384b125dc4b5fa1.jpg"}})],1),t._v(" "),s("p",[t._v("用 HTTP 协议，看个新闻还没有问题，但是换到更加严肃的场景中，就存在很多的安全风险。例如，你要下单做一次支付，如果还是使用普通的 HTTP 协议，那你很可能会被黑客盯上。")]),t._v(" "),s("p",[t._v("你发送一个请求，说我要点个外卖，但是这个网络包被截获了，于是在服务器回复你之前，黑客先假装自己就是外卖网站，然后给你回复一个假的消息说：“好啊好啊，来来来，银行卡号、密码拿来。”如果这时候你真把银行卡密码发给它，那你就真的上套了。")]),t._v(" "),t._m(2),t._v(" "),s("p",[t._v("在对称加密算法中，加密和解密使用的密钥是相同的。也就是说，加密和解密使用的是同一个密钥。因此，对称加密算法要保证安全性的话，密钥要做好保密。只能让使用的人知道，不能对外公开。")]),t._v(" "),s("p",[t._v("在非对称加密算法中，加密使用的密钥和解密使用的密钥是不相同的。一把是作为公开的公钥，另一把是作为谁都不能给的私钥。公钥加密的信息，只有私钥才能解密。私钥加密的信息，只有公钥才能解密。")]),t._v(" "),s("p",[t._v("因为对称加密算法相比非对称加密算法来说，效率要高得多，性能也好，所以交互的场景下多用对称加密。")]),t._v(" "),t._m(3),t._v(" "),s("p",[t._v("假设你和外卖网站约定了一个密钥，你发送请求的时候用这个密钥进行加密，外卖网站用同样的密钥进行解密。这样就算中间的黑客截获了你的请求，但是它没有密钥，还是破解不了。")]),t._v(" "),s("p",[t._v("这看起来很完美，但是中间有个问题，你们两个怎么来约定这个密钥呢？如果这个密钥在互联网上传输，也是很有可能让黑客截获的。黑客一旦截获这个秘钥，它可以佯作不知，静静地等着你们两个交互。这时候你们之间互通的任何消息，它都能截获并且查看，就等你把银行卡账号和密码发出来。")]),t._v(" "),s("p",[t._v("我们在谍战剧里面经常看到这样的场景，就是特工破译的密码会有个密码本，截获无线电台，通过密码本就能将原文破解出来。怎么把密码本给对方呢？只能通过线下传输。")]),t._v(" "),s("p",[t._v("比如，你和外卖网站偷偷约定时间地点，它给你一个纸条，上面写着你们两个的密钥，然后说以后就用这个密钥在互联网上定外卖了。当然你们接头的时候，也会先约定一个口号，什么“天王盖地虎”之类的，口号对上了，才能把纸条给它。但是，“天王盖地虎”同样也是对称加密密钥，同样存在如何把“天王盖地虎”约定成口号的问题。而且在谍战剧中一对一接头可能还可以，在互联网应用中，客户太多，这样是不行的。")]),t._v(" "),t._m(4),t._v(" "),s("p",[t._v("所以，只要是对称加密，就会永远在这个死循环里出不来，这个时候，就需要非对称加密介入进来。")]),t._v(" "),s("p",[t._v("非对称加密的私钥放在外卖网站这里，不会在互联网上传输，这样就能保证这个秘钥的私密性。但是，对应私钥的公钥，是可以在互联网上随意传播的，只要外卖网站把这个公钥给你，你们就可以愉快地互通了。")]),t._v(" "),s("p",[t._v("比如说你用公钥加密，说“我要定外卖”，黑客在中间就算截获了这个报文，因为它没有私钥也是解不开的，所以这个报文可以顺利到达外卖网站，外卖网站用私钥把这个报文解出来，然后回复，“那给我银行卡和支付密码吧”。")]),t._v(" "),s("p",[t._v("先别太乐观，这里还是有问题的。回复的这句话，是外卖网站拿私钥加密的，互联网上人人都可以把它打开，当然包括黑客。那外卖网站可以拿公钥加密吗？当然不能，因为它自己的私钥只有它自己知道，谁也解不开。")]),t._v(" "),s("p",[t._v("另外，这个过程还有一个问题，黑客也可以模拟发送“我要定外卖”这个过程的，因为它也有外卖网站的公钥。")]),t._v(" "),s("p",[t._v("为了解决这个问题，看来一对公钥私钥是不够的，客户端也需要有自己的公钥和私钥，并且客户端要把自己的公钥，给外卖网站。")]),t._v(" "),s("p",[t._v("这样，客户端给外卖网站发送的时候，用外卖网站的公钥加密。而外卖网站给客户端发送消息的时候，使用客户端的公钥。这样就算有黑客企图模拟客户端获取一些信息，或者半路截获回复信息，但是由于它没有私钥，这些信息它还是打不开。")]),t._v(" "),t._m(5),t._v(" "),s("p",[t._v("不对称加密也会有同样的问题，如何将不对称加密的公钥给对方呢？一种是放在一个公网的地址上，让对方下载；另一种就是在建立连接的时候，传给对方。")]),t._v(" "),s("p",[t._v("这两种方法有相同的问题，那就是，作为一个普通网民，你怎么鉴别别人给你的公钥是对的。会不会有人冒充外卖网站，发给你一个它的公钥。接下来，你和它所有的互通，看起来都是没有任何问题的。毕竟每个人都可以创建自己的公钥和私钥。")]),t._v(" "),s("p",[t._v("例如，我自己搭建了一个网站 cliu8site，可以通过这个命令先创建私钥。")]),t._v(" "),t._m(6),s("p",[t._v("然后，再根据这个私钥，创建对应的公钥。")]),t._v(" "),t._m(7),t._m(8),t._v(" "),s("p",[t._v("证书里面有什么呢？当然应该有公钥，这是最重要的；还有证书的所有者，就像户口本上有你的姓名和身份证号，说明这个户口本是你的；另外还有证书的发布机构和证书的有效期，这个有点像身份证上的机构是哪个区公安局，有效期到多少年。")]),t._v(" "),s("p",[t._v("这个证书是怎么生成的呢？会不会有人假冒权威机构颁发证书呢？就像有假身份证、假户口本一样。生成证书需要发起一个证书请求，然后将这个请求发给一个权威机构去认证，这个权威机构我们称为CA（ Certifcate Authority）。")]),t._v(" "),s("p",[t._v("证书请求可以通过这个命令生成。")]),t._v(" "),t._m(9),s("p",[t._v("将这个请求发给权威机构，权威机构会给这个证书卡一个章，我们称为签名算法。问题又来了，那怎么签名才能保证是真的权威机构签名的呢？当然只有用只掌握在权威机构手里的东西签名了才行，这就是 CA 的私钥。")]),t._v(" "),s("p",[t._v("签名算法大概是这样工作的：一般是对信息做一个 Hash 计算，得到一个 Hash 值，这个过程是不可逆的，也就是说无法通过 Hash 值得出原来的信息内容。在把信息发送出去时，把这个 Hash 值加密后，作为一个签名和信息一起发出去。")]),t._v(" "),s("p",[t._v("权威机构给证书签名的命令是这样的。")]),t._v(" "),t._m(10),s("p",[t._v("这个命令会返回 Signature ok，而 cliu8sitecertificate.pem 就是签过名的证书。CA 用自己的私钥给外卖网站的公钥签名，就相当于给外卖网站背书，形成了外卖网站的证书。")]),t._v(" "),s("p",[t._v("我们来查看这个证书的内容。")]),t._v(" "),t._m(11),s("p",[t._v("这里面有个 Issuer，也即证书是谁颁发的；\nSubject，就是证书颁发给谁；\nValidity 是证书期限；\nPublic-key 是公钥内容；\nSignature Algorithm 是签名算法。")]),t._v(" "),s("p",[t._v("这下好了，你不会从外卖网站上得到一个公钥，而是会得到一个证书，这个证书有个发布机构 CA，你只要得到这个发布机构 CA 的公钥，去解密外卖网站证书的签名，如果解密成功了，Hash 也对的上，就说明这个外卖网站的公钥没有啥问题。")]),t._v(" "),s("p",[t._v("你有没有发现，又有新问题了。要想验证证书，需要 CA 的公钥，问题是，你怎么确定 CA 的公钥就是对的呢？")]),t._v(" "),s("p",[t._v("所以，CA 的公钥也需要更牛的 CA 给它签名，然后形成 CA 的证书。要想知道某个 CA 的证书是否可靠，要看 CA 的上级证书的公钥，能不能解开这个 CA 的签名。就像你不相信区公安局，可以打电话问市公安局，让市公安局确认区公安局的合法性。这样层层上去，直到全球皆知的几个著名大 CA，称为root CA，做最后的背书。通过这种层层授信背书的方式，从而保证了非对称加密模式的正常运转。")]),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),s("p",[t._v("我们可以知道，非对称加密在性能上不如对称加密，那是否能将两者结合起来呢？例如，公钥私钥主要用于传输对称加密的秘钥，而真正的双方大数据量的通信都是通过对称加密进行的。")]),t._v(" "),s("p",[t._v("当然是可以的。这就是 HTTPS 协议的总体思路。")]),t._v(" "),s("ClientOnly",[s("img-viewer",{attrs:{url:"https://static001.geekbang.org/resource/image/70/02/7042f5c3d9e3437d5b0b30b30f43c802.jpg"}})],1),t._v(" "),s("p",[t._v("当你登录一个外卖网站的时候，由于是 HTTPS，客户端会发送 Client Hello 消息到服务器，以明文传输 TLS 版本信息、加密套件候选列表、压缩算法候选列表等信息。另外，还会有一个随机数，在协商对称密钥的时候使用。")]),t._v(" "),s("p",[t._v("这就类似在说：“您好，我想定外卖，但你要保密我吃的是什么。这是我的加密套路，再给你个随机数，你留着。”")]),t._v(" "),s("p",[t._v("然后，外卖网站返回 Server Hello 消息, 告诉客户端，服务器选择使用的协议版本、加密套件、压缩算法等，还有一个随机数，用于后续的密钥协商。")]),t._v(" "),s("p",[t._v("这就类似在说：“您好，保密没问题，你的加密套路还挺多，咱们就按套路 2 来吧，我这里也有个随机数，你也留着。”")]),t._v(" "),s("p",[t._v("然后，外卖网站会给你一个服务器端的证书，然后说：“Server Hello Done，我这里就这些信息了。”")]),t._v(" "),s("p",[t._v("你当然不相信这个证书，于是你从自己信任的 CA 仓库中，拿 CA 的证书里面的公钥去解密外卖网站的证书。如果能够成功，则说明外卖网站是可信的。这个过程中，你可能会不断往上追溯 CA、CA 的 CA、CA 的 CA 的 CA，反正直到一个授信的 CA，就可以了。")]),t._v(" "),s("p",[t._v("证书验证完毕之后，觉得这个外卖网站可信，于是客户端计算产生随机数字 Pre-master，发送 Client Key Exchange，用证书中的公钥加密，再发送给服务器，服务器可以通过私钥解密出来。")]),t._v(" "),s("p",[t._v("到目前为止，无论是客户端还是服务器，都有了三个随机数，分别是：自己的、对端的，以及刚生成的 Pre-Master 随机数。通过这三个随机数，可以在客户端和服务器产生相同的对称密钥。")]),t._v(" "),s("p",[t._v("有了对称密钥，客户端就可以说：“Change Cipher Spec，咱们以后都采用协商的通信密钥和加密算法进行加密通信了。”")]),t._v(" "),s("p",[t._v("然后发送一个 Encrypted Handshake Message，将已经商定好的参数等，采用协商密钥进行加密，发送给服务器用于数据与握手验证。")]),t._v(" "),s("p",[t._v("同样，服务器也可以发送 Change Cipher Spec，说：“没问题，咱们以后都采用协商的通信密钥和加密算法进行加密通信了”，并且也发送 Encrypted Handshake Message 的消息试试。当双方握手结束之后，就可以通过对称密钥进行加密传输了。")]),t._v(" "),s("p",[t._v("这个过程除了加密解密之外，其他的过程和 HTTP 是一样的，过程也非常复杂。")]),t._v(" "),s("p",[t._v("上面的过程只包含了 HTTPS 的单向认证，也即客户端验证服务端的证书，是大部分的场景，也可以在更加严格安全要求的情况下，启用双向认证，双方互相验证证书。")]),t._v(" "),t._m(14),t._v(" "),s("p",[t._v("其实，这里还有一些没有解决的问题，例如重放和篡改的问题。")]),t._v(" "),s("p",[t._v("没错，有了加密和解密，黑客截获了包也打不开了，但是它可以发送 N 次。这个往往通过 Timestamp 和 Nonce 随机数联合起来，然后做一个不可逆的签名来保证。")]),t._v(" "),s("p",[t._v("Nonce 随机数保证唯一，或者 Timestamp 和 Nonce 合起来保证唯一，同样的，请求只接受一次，于是服务器多次受到相同的 Timestamp 和 Nonce，则视为无效即可。")]),t._v(" "),s("p",[t._v("如果有人想篡改 Timestamp 和 Nonce，还有签名保证不可篡改性，如果改了用签名算法解出来，就对不上了，可以丢弃了。")]),t._v(" "),t._m(15),t._v(" "),s("p",[t._v("好了，这一节就到这里了，我们来总结一下。")]),t._v(" "),t._m(16),t._v(" "),s("p",[t._v("最后，给你留两个思考题：")]),t._v(" "),t._m(17)],1)},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"第15讲-https协议：点外卖的过程原来这么复杂"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第15讲-https协议：点外卖的过程原来这么复杂","aria-hidden":"true"}},[this._v("#")]),this._v(" 第15讲 | HTTPS协议：点外卖的过程原来这么复杂")])},function(){var t=this.$createElement,e=this._self._c||t;return e("blockquote",[e("p",[this._v("2018-06-20 刘超")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("那怎么解决这个问题呢？当然一般的思路就是加密。\n加密分为两种方式一种是 "),e("strong",[this._v("对称加密")]),this._v("，一种是 "),e("strong",[this._v("非对称加密")]),this._v("。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"对称加密"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#对称加密","aria-hidden":"true"}},[this._v("#")]),this._v(" 对称加密")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"非对称加密"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#非对称加密","aria-hidden":"true"}},[this._v("#")]),this._v(" 非对称加密")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"数字证书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数字证书","aria-hidden":"true"}},[this._v("#")]),this._v(" 数字证书")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("openssl genrsa -out cliu8siteprivate.key 1024\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("openssl rsa -in cliu8siteprivate.key -pubout -outcliu8sitepublic.pem\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("这个时候就需要权威部门的介入了，就像每个人都可以打印自己的简历，说自己是谁，但是有公安局盖章的，就只有户口本，这个才能证明你是你。这个由权威部门颁发的称为 "),e("strong",[this._v("证书（Certificate）")]),this._v("。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("openssl req -key cliu8siteprivate.key -new -out cliu8sitecertificate.req\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("openssl x509 -req -in cliu8sitecertificate.req -CA cacertificate.pem -CAkey caprivate.key -out cliu8sitecertificate.pem\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("openssl x509 -in cliu8sitecertificate.pem -noout -text\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("除此之外，还有一种证书，称为 "),e("strong",[this._v("Self-Signed Certificate，就是自己给自己签名")]),this._v("。这个给人一种“我就是我，你爱信不信”的感觉。这里我就不多说了。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"https-的工作模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#https-的工作模式","aria-hidden":"true"}},[this._v("#")]),this._v(" HTTPS 的工作模式")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"重放与篡改"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#重放与篡改","aria-hidden":"true"}},[this._v("#")]),this._v(" 重放与篡改")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小结","aria-hidden":"true"}},[this._v("#")]),this._v(" 小结")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("p",[this._v("密分对称加密和非对称加密。对称加密效率高，但是解决不了密钥传输问题；非对称加密可以解决这个问题，但是效率不高。")])]),this._v(" "),e("li",[e("p",[this._v("非对称加密需要通过证书和权威机构来验证公钥的合法性。")])]),this._v(" "),e("li",[e("p",[this._v("HTTPS 是综合了对称加密和非对称加密算法的 HTTP 协议。既保证传输安全，也保证传输效率。")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[e("p",[this._v("HTTPS 协议比较复杂，沟通过程太繁复，这样会导致效率问题，那你知道有哪些手段可以解决这些问题吗？")])]),this._v(" "),e("li",[e("p",[this._v("HTTP 和 HTTPS 协议的正文部分传输个 JSON 什么的还好，如果播放视频，就有问题了，那这个时")])])])}],!1,null,null,null);e.default=_.exports}}]);